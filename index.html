<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Call Mithra</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #fdfdfd;
      margin: 0;
      padding: 0;
    }
    .chat-container {
      max-width: 480px;
      margin: auto;
      padding: 16px;
    }
    .header {
      text-align: center;
      margin-bottom: 4px;
      font-size: 1.8em;
      font-weight: bold;
      color: maroon;
    }
    .slogan {
      text-align: center;
      color: black;
      font-size: 0.95em;
      margin-bottom: 16px;
    }
    select, button {
      width: 100%;
      padding: 10px;
      margin-top: 8px;
      border-radius: 6px;
      border: 1px solid #aaa;
      font-size: 1rem;
    }
    #chatbox {
      margin-top: 16px;
    }
    .card {
      background: #fff;
      border: 1px solid #ddd;
      border-left: 5px solid maroon;
      padding: 12px;
      margin-bottom: 10px;
      border-radius: 8px;
      font-size: 1.1em;
      color: maroon;
    }
    .error {
      color: red;
      margin-top: 12px;
    }
    .modal-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 999;
    }
    .modal {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      max-width: 90%;
      max-height: 80%;
      overflow-y: auto;
      position: relative;
    }
    .modal h3 {
      margin-top: 0;
      color: maroon;
    }
    .close-btn {
      position: absolute;
      top: 8px;
      right: 12px;
      background: none;
      border: none;
      font-size: 1.2em;
      cursor: pointer;
    }
    .button-group {
      display: flex;
      justify-content: space-between;
      margin-top: 16px;
      gap: 10px;
    }
    .button-group button {
      flex: 1;
    }
  </style>
</head>
<body>
  <div class="chat-container">
    <div class="header">Call Mithra</div>
    <div class="slogan">Together For A Better Tomorrow</div>

    <select id="placeSelect">
      <option value="">-- Select Place --</option>
      <option>Alampallam</option>
      <option>Kollengode</option>
      <option>Mathur</option>
    </select>

    <select id="categorySelect">
      <option value="">-- Select Category --</option>
      <option>Caterers</option>
      <option>Vaideekhal</option>
      <option>Temple Priests</option>
      <option>Business</option>
      <option>Advocates</option>
      <option>Other Services</option>
    </select>

    <select id="faqSelect">
      <option value="">-- Select FAQ --</option>
      <option>Who is Mithra?</option>
      <option>Can we use Call Mithra App free?</option>
      <option>Are the phone numbers updated often?</option>
      <option>Contact Mithra</option>
    </select>

    <div class="button-group">
      <button onclick="fetchEvents()">Events</button>
      <button onclick="fetchPanchang()">Panchang</button>
    </div>

    <div id="chatbox"></div>
  </div>

  <!-- Modal Overlay -->
  <div id="modalOverlay" class="modal-overlay" onclick="closeModal(event)">
    <div id="modalContent" class="modal" onclick="event.stopPropagation()">
      <button class="close-btn" onclick="closeModal()">Ã—</button>
      <h3 id="modalTitle"></h3>
      <div id="modalBody"></div>
    </div>
  </div>

  <script>
    const contactsUrl = 'https://script.google.com/macros/s/AKfycbxiscDtPyqy6WCjU7BKUR5Ro3AdtZz7q9wD5fwOheAh1TpSaMxlkgc0TzgTNHXkkG70yw/exec';
    const faqUrl = 'https://script.google.com/macros/s/AKfycbxqvwmPTZT7RBm3PwxhuAYUYgu-7RnGhmWO7zrO3qUVXYg1nXl3Wewv9HE3n8fHQKxU/exec';
    const eventsUrl = 'https://script.google.com/macros/s/AKfycbyREuWL3hPqmJj9T_g-LjDwB34D9DSaPD2KzjFx8Zd_aSUPMEu_ysqKqraeT6USx3Pmww/exec';
    const panchangUrl = 'https://script.google.com/macros/s/AKfycbzUdmenvxUvm64nc6HMiPimJIJCyYpPpiyLzl--veCZ7YGAaNjJzHtBpWV9Q4FKXu7r/exec';
    const usageUrl = 'https://script.google.com/macros/s/AKfycbwBJI8rqGMfLHXQMwwIF8BcKvR-uH9FHdcnTO5fN6TlCxIMQY7gR_R_iF-l8tLdLwc-jg/exec';

    const placeSelect = document.getElementById('placeSelect');
    const categorySelect = document.getElementById('categorySelect');
    const faqSelect = document.getElementById('faqSelect');
    const chatbox = document.getElementById('chatbox');

    placeSelect.addEventListener('change', fetchContacts);
    categorySelect.addEventListener('change', fetchContacts);
    faqSelect.addEventListener('change', fetchFaq);

    async function fetchContacts() {
      const place = placeSelect.value;
      const category = categorySelect.value;
      faqSelect.value = "";
      if (!place || !category) return;
      chatbox.innerHTML = "Loading...";
      try {
        const res = await fetch(`${contactsUrl}?place=${encodeURIComponent(place)}&category=${encodeURIComponent(category)}`);
        const data = await res.json();
        showUsage("contacts", `${place} - ${category}`);
        displayCards(data.reply, place, category);
      } catch {
        chatbox.innerHTML = `<div class="error">Server unreachable. Try again.</div>`;
      }
    }

    async function fetchFaq() {
      const faq = faqSelect.value;
      placeSelect.value = "";
      categorySelect.value = "";
      if (!faq) return;
      chatbox.innerHTML = "Loading...";
      try {
        const res = await fetch(`${faqUrl}?faq=${encodeURIComponent(faq)}`);
        const data = await res.json();
        showUsage("faq", faq);
        chatbox.innerHTML = `<div class="card">${data.reply}</div>`;
      } catch {
        chatbox.innerHTML = `<div class="error">Server unreachable. Try again.</div>`;
      }
    }

    function displayCards(response, place, category) {
      if (!response || response === "No contacts found for the selected place and category.") {
        chatbox.innerHTML = `<div class="error">No contacts found for ${place} - ${category}.</div>`;
        return;
      }
      const lines = response.trim().split("\n");
      chatbox.innerHTML = lines.map(line => `<div class="card">${place} ${category}<br>${line}</div>`).join("");
    }

    function closeModal() {
      document.getElementById("modalOverlay").style.display = "none";
    }

    async function fetchEvents() {
      try {
        const res = await fetch(eventsUrl);
        const data = await res.json();
        const html = data.reply.map(item => `<div><strong>${formatDate(item.date)}</strong>: ${item.event}</div>`).join("<hr>");
        showModal("Upcoming Events", html);
        showUsage("events", "viewed");
      } catch {
        showModal("Events", "<div class='error'>No event data found.</div>");
      }
    }

    async function fetchPanchang() {
      try {
        const res = await fetch(panchangUrl);
        const data = await res.json();
        const html = data.reply.map(item => `<div><strong>${formatDate(item.date)}</strong>: ${item.details}</div>`).join("<hr>");
        showModal("3-Day Panchang", html);
        showUsage("panchang", "viewed");
      } catch {
        showModal("Panchang", "<div class='error'>No panchang data found.</div>");
      }
    }

    function showModal(title, body) {
      document.getElementById("modalTitle").innerText = title;
      document.getElementById("modalBody").innerHTML = body;
      document.getElementById("modalOverlay").style.display = "flex";
    }

    function formatDate(dateString) {
      const d = new Date(dateString);
      return d.toLocaleDateString("en-IN", { day: '2-digit', month: 'long', year: 'numeric' });
    }

    async function showUsage(type, detail) {
      try {
        await fetch(usageUrl, {
          method: "POST",
          body: JSON.stringify({ type, detail, time: new Date().toISOString() }),
          headers: { "Content-Type": "application/json" }
        });
      } catch (e) {
        console.log("Usage log failed");
      }
    }
  </script>
</body>
</html>
