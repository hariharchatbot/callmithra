<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>callMithra</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 0;
      background: #f4f4f4;
    }
    .chat-container {
      max-width: 480px;
      margin: 0 auto;
      background: #fff;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .header {
      text-align: center;
      font-size: 1.8em;
      font-weight: bold;
      color: #ff9933;
    }
    .slogan {
      text-align: center;
      font-size: 1em;
      color: #555;
      margin-bottom: 20px;
    }
    select, button {
      width: 100%;
      margin-top: 10px;
      padding: 10px;
      font-size: 1em;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    .chatbox {
      margin-top: 20px;
      min-height: 180px;
      background: #f9f9f9;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      white-space: pre-wrap;
    }
    .message {
      margin-bottom: 12px;
    }
    .bot {
      color: maroon;
    }
    .user {
      color: #007bff;
      text-align: right;
      font-weight: bold;
    }
    .error {
      color: red;
    }
    .card {
      border-bottom: 1px solid #ddd;
      padding-bottom: 8px;
      margin-bottom: 8px;
    }
    .modal, .overlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.5);
    }
    .modal-content {
      background: #fff;
      padding: 20px;
      margin: 10% auto;
      width: 90%;
      max-width: 400px;
      border-radius: 8px;
    }
    .feedback {
      text-align: center;
      margin-top: 10px;
    }
    .feedback button {
      font-size: 1.5rem;
      margin: 0 10px;
    }
    .loader {
      display: none;
      text-align: center;
      margin-top: 10px;
      font-style: italic;
      color: #555;
    }
  </style>
</head>
<body>
  <div class="chat-container">
    <div class="header">callMithra</div>
    <div class="slogan">Together For A Better Tomorrow</div>

    <select id="place">
      <option value="">-- Select Place --</option>
      <option>Alampallam</option>
      <option>Kollengode</option>
      <option>Mathur</option>
    </select>

    <select id="category">
      <option value="">-- Select Category --</option>
      <option>Caterers</option>
      <option>Temple Priests</option>
      <option>Business</option>
      <option>Advocates</option>
      <option>Other Services</option>
    </select>

    <select id="faq">
      <option value="">-- Select FAQ --</option>
      <option>Who is Mithra?</option>
      <option>Can we use Call Mithra App free?</option>
      <option>Are the phone numbers updated often?</option>
      <option>Contact Mithra</option>
    </select>

    <div class="chatbox" id="chatbox"></div>

    <div class="feedback">
      <span>Was this helpful?</span>
      <button onclick="logFeedback('up')">üëç</button>
      <button onclick="logFeedback('down')">üëé</button>
    </div>

    <button onclick="showModal('events')">Events <span style="color:red; font-size:0.9em;">New!</span></button>
    <button onclick="showModal('panchang')">Panchang</button>

    <div class="loader" id="loader">Loading...</div>
  </div>

  <!-- Modals -->
  <div class="overlay" id="overlay" onclick="hideModal()"></div>
  <div class="modal" id="eventsModal">
    <div class="modal-content" id="eventsContent"></div>
  </div>
  <div class="modal" id="panchangModal">
    <div class="modal-content" id="panchangContent"></div>
  </div>

  <script>
    const contactsUrl = 'https://script.google.com/macros/s/AKfycbyahR2hdj4aHZIM2ttITAhslZwNVpH11nGGmsnbrT082pV-NKESpy29F2rimnPKVsKNpw/exec';
    const faqUrl = 'https://script.google.com/macros/s/AKfycbxqvwmPTZT7RBm3PwxhuAYUYgu-7RnGhmWO7zrO3qUVXYg1nXl3Wewv9HE3n8fHQKxU/exec';
    const eventsUrl = 'https://script.google.com/macros/s/AKfycbx-38nfgX6yTwTvXrgnE77sDw99mETKyxyGzH28CAhuLmqtO8fsTMQrEyuqZHlljrfVBQ/exec';
    const panchangUrl = 'https://script.google.com/macros/s/AKfycby5p66Ixg4CbGkr6Vh6kBn4A9vjfS8GdflkhddY114h-SKVNPE_Xx0140BuoQJ7UWce/exec';
    const usageLogUrl = 'https://script.google.com/macros/s/AKfycbwBJI8rqGMfLHXQMwwIF8BcKvR-uH9FHdcnTO5fN6TlCxIMQY7gR_R_iF-l8tLdLwc-jg/exec';

    const placeSelect = document.getElementById('place');
    const categorySelect = document.getElementById('category');
    const faqSelect = document.getElementById('faq');
    const chatbox = document.getElementById('chatbox');
    const loader = document.getElementById('loader');

    async function fetchData(url) {
      loader.style.display = 'block';
      const response = await fetch(url);
      loader.style.display = 'none';
      return response.json();
    }

    function showMessage(text, sender = 'bot') {
      const div = document.createElement('div');
      div.className = `message ${sender}`;
      div.innerHTML = text;
      chatbox.appendChild(div);
      chatbox.scrollTop = chatbox.scrollHeight;
    }

    async function fetchContacts() {
      const place = placeSelect.value;
      const category = categorySelect.value;
      if (!place || !category) return;

      chatbox.innerHTML = '';
      try {
        const data = await fetchData(`${contactsUrl}?place=${place}&category=${category}`);
        const reply = data.reply || 'No data';
        const entries = reply.split('\n');
        showMessage(`<strong>${place} ${category}</strong>`, 'user');
        entries.forEach(line => {
          if (line.trim()) showMessage(`<div class='card'>${line}</div>`, 'bot');
        });
        logUsage('contact', `${place}-${category}`);
      } catch {
        showMessage('Server error. Please try again.', 'error');
      }
    }

    async function fetchFaq() {
      const question = faqSelect.value;
      if (!question) return;
      chatbox.innerHTML = '';
      showMessage(`You asked: ${question}`, 'user');
      try {
        const data = await fetchData(`${faqUrl}?faq=${encodeURIComponent(question)}`);
        showMessage(data.reply, 'bot');
        logUsage('faq', question);
      } catch {
        showMessage('Server error. Please try again.', 'error');
      }
    }

    async function showModal(type) {
      document.getElementById('overlay').style.display = 'block';
      const modal = document.getElementById(type + 'Modal');
      modal.style.display = 'block';
      const url = type === 'events' ? eventsUrl : panchangUrl;
      const content = await fetchData(url);
      document.getElementById(type + 'Content').innerText = content.reply || 'No data found.';
      logUsage(type, 'shown');
    }

    function hideModal() {
      document.querySelectorAll('.modal, .overlay').forEach(el => el.style.display = 'none');
    }

    async function logFeedback(type) {
      await fetch(usageLogUrl + `?feedback=${type}`);
    }

    async function logUsage(type, query) {
      await fetch(usageLogUrl + `?type=${type}&query=${encodeURIComponent(query)}`);
    }

    placeSelect.onchange = categorySelect.onchange = fetchContacts;
    faqSelect.onchange = () => {
      placeSelect.value = categorySelect.value = '';
      fetchFaq();
    };

    window.onload = () => {
      showModal('events');
    };
  </script>
</body>
</html>
