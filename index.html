<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>callMithra Chatbot</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f5f5;
      margin: 0; padding: 20px;
      display: flex; justify-content: center;
    }
    .chat-container {
      background: white;
      width: 100%;
      max-width: 480px;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.15);
      display: flex;
      flex-direction: column;
      padding: 20px;
    }
    .header {
      color: #FF9933;
      font-size: 1.8rem;
      font-weight: 700;
      text-align: center;
      margin-bottom: 4px;
    }
    .slogan {
      font-style: italic;
      color: #666;
      text-align: center;
      margin-bottom: 20px;
    }
    label {
      font-weight: 600;
      margin-top: 10px;
      display: block;
      color: #333;
    }
    select {
      width: 100%;
      padding: 10px;
      margin-top: 6px;
      border-radius: 6px;
      border: 1.5px solid #ccc;
      font-size: 1rem;
    }
    button {
      margin-top: 12px;
      padding: 10px 15px;
      font-size: 1rem;
      cursor: pointer;
      border-radius: 6px;
      border: none;
      background-color: #FF9933;
      color: white;
    }
    #chatbox {
      margin-top: 20px;
      min-height: 180px;
      background: #fafafa;
      border-radius: 8px;
      padding: 15px;
      border: 1px solid #ddd;
      white-space: pre-wrap;
      overflow-y: auto;
    }
    .message-card {
      background: #800000;
      color: white;
      padding: 12px;
      border-radius: 10px;
      margin-bottom: 12px;
    }
    .error-card {
      background: #cc0000;
      color: white;
      padding: 12px;
      border-radius: 10px;
      margin-bottom: 12px;
    }
    .contact-card {
      background: #fdf0f0;
      border: 1.5px solid #800000;
      padding: 12px;
      border-radius: 10px;
      margin-bottom: 10px;
    }
    .contact-header {
      font-weight: 700;
      color: #800000;
      margin-bottom: 6px;
    }
    .divider {
      border-bottom: 1px solid #ddd;
      margin: 8px 0;
    }
    .loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #FF9933;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 10px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg);}
      100% { transform: rotate(360deg);}
    }
    .feedback {
      margin-top: 10px;
      text-align: center;
    }
    .feedback button {
      font-size: 1.3rem;
      margin: 0 10px;
      background: none;
      border: none;
      cursor: pointer;
    }
    .feedback button:hover {
      color: #FF9933;
    }
    /* Modal */
    #modal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.4);
      display: none;
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: white;
      padding: 20px;
      max-width: 420px;
      width: 90%;
      border-radius: 12px;
      position: relative;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 8px 20px rgba(0,0,0,0.25);
    }
    .close-btn {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      color: #555;
      user-select: none;
    }
    .close-btn:hover {
      color: #000;
    }
  </style>
</head>
<body>

<div class="chat-container">
  <div class="header">callMithra</div>
  <div class="slogan">Together For A Better Tomorrow</div>

  <label for="placeSelect">Select Place:</label>
  <select id="placeSelect">
    <option value="">-- Select Place --</option>
    <option>Alampallam</option>
    <option>Kollengode</option>
    <option>Mathur</option>
  </select>

  <label for="categorySelect">Select Category:</label>
  <select id="categorySelect">
    <option value="">-- Select Category --</option>
    <option>Caterers</option>
    <option>Vaideekhal</option>
    <option>Temple Priests</option>
    <option>Business</option>
    <option>Advocates</option>
    <option>Other Services</option>
  </select>

  <label for="faqSelect">Select FAQ:</label>
  <select id="faqSelect">
    <option value="">-- Select FAQ --</option>
    <option>Who is Mithra?</option>
    <option>Can we use Call Mithra App free?</option>
    <option>Are the phone numbers updated often?</option>
    <option>Contact Mithra</option>
  </select>

  <div id="chatbox"></div>

  <button id="eventsBtn">Events</button>
  <button id="panchangBtn">Panchang</button>
</div>

<div id="modal">
  <div class="modal-content">
    <span id="closeModal" class="close-btn">&times;</span>
    <div id="modalBody">Loading...</div>
    <div class="feedback">
      <button onclick="alert('üëç Thank you for your feedback!')">üëç</button>
      <button onclick="alert('üëé Thank you for your feedback!')">üëé</button>
    </div>
  </div>
</div>

<script>
  const contactsUrl = 'https://script.google.com/macros/s/AKfycbyahR2hdj4aHZIM2ttITAhslZwNVpH11nGGmsnbrT082pV-NKESpy29F2rimnPKVsKNpw/exec';
  const faqUrl = 'https://script.google.com/macros/s/AKfycbxqvwmPTZT7RBm3PwxhuAYUYgu-7RnGhmWO7zrO3qUVXYg1nXl3Wewv9HE3n8fHQKxU/exec';
  const eventsUrl = 'https://script.google.com/macros/s/AKfycbx-38nfgX6yTwTvXrgnE77sDw99mETKyxyGzH28CAhuLmqtO8fsTMQrEyuqZHlljrfVBQ/exec';
  const panchangUrl = 'https://script.google.com/macros/s/AKfycby5p66Ixg4CbGkr6Vh6kBn4A9vjfS8GdflkhddY114h-SKVNPE_Xx0140BuoQJ7UWce/exec';
  const usageUrl = 'https://script.google.com/macros/s/AKfycbwBJI8rqGMfLHXQMwwIF8BcKvR-uH9FHdcnTO5fN6TlCxIMQY7gR_R_iF-l8tLdLwc-jg/exec';

  const placeSelect = document.getElementById('placeSelect');
  const categorySelect = document.getElementById('categorySelect');
  const faqSelect = document.getElementById('faqSelect');
  const chatbox = document.getElementById('chatbox');
  const modal = document.getElementById('modal');
  const modalBody = document.getElementById('modalBody');
  const closeModal = document.getElementById('closeModal');

  function appendCard(text, isError = false) {
    const div = document.createElement('div');
    div.className = isError ? 'error-card' : 'message-card';
    div.innerText = text;
    const fb = document.createElement('div');
    fb.className = 'feedback';
    fb.innerHTML = `
      <button onclick="alert('üëç Thank you for your feedback!')">üëç</button>
      <button onclick="alert('üëé Thank you for your feedback!')">üëé</button>
    `;
    div.appendChild(fb);
    chatbox.appendChild(div);
    chatbox.scrollTop = chatbox.scrollHeight;
  }

  function appendContactCard(name, phone1, phone2) {
    const card = document.createElement('div');
    card.className = 'contact-card';
    card.innerHTML = `<div class="contact-header">${name}</div>
      <div>Phone 1: ${phone1}</div>
      <div>Phone 2: ${phone2 || '-'}</div>`;
    chatbox.appendChild(card);
    const divider = document.createElement('div');
    divider.className = 'divider';
    chatbox.appendChild(divider);
    chatbox.scrollTop = chatbox.scrollHeight;
  }

  async function fetchContacts() {
    const place = placeSelect.value;
    const category = categorySelect.value;
    if (!place || !category) return;
    chatbox.innerHTML = '<div class="loader"></div>';
    const response = await fetch(`${contactsUrl}?place=${place}&category=${category}`);
    const data = await response.json();
    chatbox.innerHTML = '';
    if (data.reply && !data.reply.toLowerCase().includes('no contacts')) {
      appendCard(`${place} ${category}`);
      const lines = data.reply.split('\n');
      lines.forEach(line => {
        const match = line.match(/Name:\s*(.+?),\s*Phone1:\s*([^,]+)(?:,\s*Phone2:\s*(.*))?/i);
        if (match) appendContactCard(match[1], match[2], match[3] || '');
        else appendCard(line);
      });
    } else {
      appendCard(data.reply || "No contacts found", true);
    }
    fetch(usageUrl + `?type=contacts&detail=${place}-${category}`);
  }

  async function fetchFaq() {
    const faq = faqSelect.value;
    if (!faq) return;
    chatbox.innerHTML = '<div class="loader"></div>';
    const response = await fetch(`${faqUrl}?faq=${faq}`);
    const data = await response.json();
    chatbox.innerHTML = '';
    if (data.reply && !data.reply.toLowerCase().includes('could not find')) {
      appendCard(data.reply);
    } else {
      appendCard(data.reply || "Sorry, no answer found.", true);
    }
    fetch(usageUrl + `?type=faq&detail=${faq}`);
  }

  function showModal(content) {
    modalBody.innerHTML = content;
    modal.style.display = 'flex';
  }

  async function showEvents() {
    showModal('<div class="loader"></div>');
    const res = await fetch(eventsUrl);
    const data = await res.json();
    modalBody.innerHTML = `<h3>Events</h3><pre>${data.reply || "No events found"}</pre>`;
    fetch(usageUrl + `?type=events`);
  }

  async function showPanchang() {
    showModal('<div class="loader"></div>');
    const res = await fetch(panchangUrl);
    const data = await res.json();
    modalBody.innerHTML = `<h3>Panchang</h3><pre>${data.reply || "No panchang data found"}</pre>`;
    fetch(usageUrl + `?type=panchang`);
  }

  placeSelect.onchange = () => {
    faqSelect.value = '';
    fetchContacts();
  };
  categorySelect.onchange = () => {
    faqSelect.value = '';
    fetchContacts();
  };
  faqSelect.onchange = () => {
    placeSelect.value = '';
    categorySelect.value = '';
    fetchFaq();
  };

  document.getElementById('eventsBtn').onclick = showEvents;
  document.getElementById('panchangBtn').onclick = showPanchang;
  closeModal.onclick = () => modal.style.display = 'none';
  window.onclick = (e) => { if (e.target === modal) modal.style.display = 'none'; };

  window.onload = () => {
    appendCard("Hi, I am Mithra! Please select a Place and Category to get contacts or select a FAQ question.");
    showEvents(); // First visit popup
  };
</script>

</body>
</html>
